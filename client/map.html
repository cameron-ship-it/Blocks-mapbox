<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Block Selector</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
  <script>
    // STEP 1: Your Mapbox token goes here
    mapboxgl.accessToken = 'pk.eyJ1IjoiY3JvYmVydHMyOCIsImEiOiJjbWdmdWo1ZjUwY2d1MmxweW8yYnJhbnp4In0.jfGjU3SdXK599EfgAtYnAw';

    // STEP 2: Replace this with your GeoJSON data or tileset later
    const blocksGeojson = {
      "type": "FeatureCollection",
      "features": [
        {"type":"Feature","properties":{"name":"A"},"geometry":{"type":"Polygon","coordinates":[[[-73.99,40.73],[-73.98,40.73],[-73.98,40.74],[-73.99,40.74],[-73.99,40.73]]]}},
        {"type":"Feature","properties":{"name":"B"},"geometry":{"type":"Polygon","coordinates":[[[-74.00,40.73],[-73.99,40.73],[-73.99,40.74],[-74.00,40.74],[-74.00,40.73]]]}}
      ]
    };

    // STEP 3: Create the map
    const map = new mapboxgl.Map({
      container: 'map', // connects to <div id="map">
      style: 'mapbox://styles/mapbox/light-v11',
      center: [-73.99, 40.735],
      zoom: 13
    });

    map.on('load', () => {
      // Assign each feature a unique _uid
      blocksGeojson.features.forEach((feature, index) => {
        feature.properties._uid = `block-${index}`;
      });

      // Add your block data
      map.addSource('blocks', {
        type: 'geojson',
        data: blocksGeojson,
        generateId: true // gives each block a unique ID
      });

      // Add the block layer
      map.addLayer({
        id: 'blocks-fill',
        type: 'fill',
        source: 'blocks',
        paint: {
          'fill-color': [
            'case',
            ['boolean', ['feature-state', 'selected'], false],
            '#2b8a3e', // selected color (green)
            '#228be6'  // default color (blue)
          ],
          'fill-opacity': 0.6
        }
      });

      // === HIGHLIGHT LAYER (add after your blocks-fill layer) ===
      // If you have a unique property (e.g., GEOID, BBL), set uniqueField to that.
      // If you don't know, leave it as '_uid' and do Step 2 below.
      const uniqueField = '_uid'; // <- change to your unique property or '_uid' after Step 2

      map.addLayer({
        id: 'blocks-highlight',
        type: 'line',
        source: 'blocks',
        // include source-layer if your source is vector:
        // 'source-layer': 'blocks',
        paint: {
          'line-width': 3,
          'line-color': '#111'
        },
        // Start with nothing selected
        filter: ['==', ['get', uniqueField], '___none___']
      });

      // Add outlines around each block
      map.addLayer({
        id: 'blocks-outline',
        type: 'line',
        source: 'blocks',
        paint: { 'line-color': '#222', 'line-width': 1 }
      });

      // STEP 5: Handle clicks
      map.on('click', 'blocks-fill', (e) => {
        const f = e.features && e.features[0];
        if (!f) return;

        // Prefer the field you configured in Step 1
        const clickedValue = f.properties[uniqueField];

        // Safety check: if undefined, log properties so you can pick a good field
        if (clickedValue === undefined) {
          console.log('Choose a unique field from these properties:', f.properties);
          alert('The unique field "' + uniqueField + '" was not found on the feature. Check console.');
          return;
        }

        // Show only the clicked feature in the highlight layer
        map.setFilter('blocks-highlight', ['==', ['get', uniqueField], clickedValue]);
      });

      // Change cursor to pointer when hovering blocks
      map.on('mousemove', 'blocks-fill', () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave', 'blocks-fill', () => map.getCanvas().style.cursor = '');
    });
  </script>
</body>
</html>
